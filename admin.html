<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø§Ù„Ø·ÙŠØ¨Ø§Øª</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
.admin-area{max-width:1200px;margin:40px auto}
.admin-card{border-radius:12px}
.stat-box{border-radius:12px;padding:20px;text-align:center;}
.stat-num{font-size:26px;font-weight:bold;color:#c00}
#statProducts { background-color: #ffe0e0; }
#statOrders { background-color: #e0ffe0; }
#statMoney  { background-color: #e0e0ff; }
#statFeedback { background-color: #fff0b3; }
</style>
</head>
<body>

<header class="bg-danger py-2">
  <div class="container d-flex justify-content-between align-items-center">
    <a href="index.html" class="text-white fw-bold fs-4">ğŸ¯ Ø§Ù„Ø·ÙŠØ¨Ø§Øª</a>
    <div class="text-white">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
  </div>
</header>

<div class="admin-area container">

<div id="loginBox" class="card p-4 admin-card mb-4">
<h5>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h5>
<div class="row g-2">
<div class="col-md-6"><input id="adminPass" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
<div class="col-md-6 d-grid"><button id="loginBtn" class="btn btn-danger">Ø¯Ø®ÙˆÙ„</button></div>
</div>
<small class="text-muted mt-2 d-block">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123</small>
</div>

<div id="adminArea" style="display:none">

<div class="row mb-4">
<div class="col-lg-8">
<div class="card p-3 admin-card">
<h5>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h5>
<form id="prodForm" class="row g-2">
<div class="col-12"><input id="prodName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required></div>
<div class="col-6"><input id="prodPrice" type="number" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±" required></div>
<div class="col-6"><input id="prodImg" type="file" class="form-control"></div>
<div class="col-12"><textarea id="prodDesc" class="form-control" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±"></textarea></div>
<div class="col-12 d-grid"><button class="btn btn-warning" type="submit">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button></div>
</form>
</div>
</div>

<div class="col-lg-4">
<div class="card p-3 admin-card">
<h5 class="text-center mb-3">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h5>
<div class="stat-box mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª<div id="statProducts" class="stat-num">0</div></div>
<div class="stat-box mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª<div id="statOrders" class="stat-num">0</div></div>
<div class="stat-box mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª<div id="statMoney" class="stat-num">0 Ø¬.Ù…</div></div>
<div class="stat-box">Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ<div id="statFeedback" class="stat-num">0</div></div>
</div>
</div>
</div>

<div class="card p-3 admin-card mb-4">
<h5>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
<div id="adminProducts" class="row g-3"></div>
</div>

<div class="card p-3 admin-card mb-4">
<h5>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
<div class="table-responsive mt-2">
<table class="table table-bordered">
<thead class="table-danger">
<tr><th>Ø±Ù‚Ù…</th><th>Ø¹Ù…ÙŠÙ„</th><th>Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªÙ…ØŸ</th><th>ÙØ§ØªÙˆØ±Ø©</th><th>Ø­Ø°Ù</th></tr>
</thead>
<tbody id="ordersBody"></tbody>
</table>
</div>
</div>

<div class="card p-3 admin-card mb-4">
<h5>Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</h5>
<div id="feedbackList"></div>
</div>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<script>
/* ğŸŸ¥ Login */
const loginBox=document.getElementById('loginBox');
const adminArea=document.getElementById('adminArea');
const loginBtn=document.getElementById('loginBtn');
const adminPass=document.getElementById('adminPass');

loginBtn.addEventListener('click', loginAdmin);
adminPass.addEventListener('keypress', e=>{ if(e.key==='Enter') loginAdmin(); });

function loginAdmin(){
if(adminPass.value==='admin123'){
loginBox.style.display='none';
adminArea.style.display='block';
loadAdmin();
}else alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
}

/* ğŸŸ¥ LocalStorage Shortcuts */
const fetchProducts=()=>JSON.parse(localStorage.getItem('et_products')||'[]');
const saveProducts=arr=>localStorage.setItem('et_products',JSON.stringify(arr));
const fetchOrders=()=>JSON.parse(localStorage.getItem('et_orders')||'[]');
const saveOrders=arr=>localStorage.setItem('et_orders',JSON.stringify(arr));
const fetchFeedback=()=>JSON.parse(localStorage.getItem('et_feedback')||'[]');
const saveFeedback=arr=>localStorage.setItem('et_feedback',JSON.stringify(arr));

/* ğŸŸ¥ Dashboard Loader */
function loadAdmin(){
renderAdminProducts();
renderAdminOrders();
renderFeedback();
updateStats();
}

/* ğŸŸ© Stats Update */
function updateStats(){
const p=fetchProducts();
const o=fetchOrders();
const f=fetchFeedback();
// ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù‡Ù†Ø§ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
let money=0; o.forEach(x=>money+= (x["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] || x.total || 0) );
document.getElementById('statProducts').innerText=p.length;
document.getElementById('statOrders').innerText=o.length;
document.getElementById('statMoney').innerText=money+' Ø¬.Ù…';
document.getElementById('statFeedback').innerText=f.length;
}

/* ğŸŸ¨ Product CRUD */
let editIndex=null;
document.getElementById('prodForm').addEventListener('submit', e=>{
e.preventDefault();
const name=document.getElementById('prodName').value.trim();
const price=parseFloat(document.getElementById('prodPrice').value)||0;
const desc=document.getElementById('prodDesc').value.trim();
let img='assets/placeholder.jpg';
const fileInput=document.getElementById('prodImg');
if(fileInput.files && fileInput.files[0]){
const reader=new FileReader();
reader.onload=function(e){ img=e.target.result; saveProductAndRender(name,price,img,desc); }
reader.readAsDataURL(fileInput.files[0]);
}else saveProductAndRender(name,price,img,desc);
});

function saveProductAndRender(name,price,img,desc){
const arr=fetchProducts();
if(editIndex!==null){ arr[editIndex]={...arr[editIndex],name,price,img,desc}; editIndex=null; } 
else arr.unshift({id:Date.now(),name,price,img,desc});
saveProducts(arr); document.getElementById('prodForm').reset(); renderAdminProducts(); updateStats();
}

function renderAdminProducts(){
const arr=fetchProducts(); const box=document.getElementById('adminProducts'); box.innerHTML='';
arr.forEach((p,i)=>{
box.innerHTML+=`
<div class="col-12">
<div class="d-flex justify-content-between border p-2 rounded align-items-center">
<div>
<strong>${p.name}</strong><br><span class="text-danger">${p.price} Ø¬.Ù…</span><br>${p.desc}
</div>
<div>
<button class="btn btn-sm btn-primary" onclick="editProd(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
<button class="btn btn-sm btn-danger" onclick="delProd(${i})">Ø­Ø°Ù</button>
</div>
</div></div>`; });
}

function editProd(i){
const arr=fetchProducts(); const p=arr[i];
document.getElementById('prodName').value=p.name;
document.getElementById('prodPrice').value=p.price;
document.getElementById('prodDesc').value=p.desc;
editIndex=i;
}

function delProd(i){
if(!confirm('Ø­Ø°ÙØŸ'))return;
const arr=fetchProducts(); arr.splice(i,1);
saveProducts(arr); renderAdminProducts(); updateStats();
}

/* ğŸŸ¦ Orders (ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) */

// ğŸ”´ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ğŸ”´ Admin Orders rendering (ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
function renderAdminOrders(){
  const table = document.getElementById("ordersBody");
  if(!table) return;

  const arr = fetchOrders();
  table.innerHTML = "";
  arr.forEach((o,i)=>{

    const id = o["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"] || o.id || (arr.length - i);
    const client = o["Ø§Ù„Ø¹Ù…ÙŠÙ„"] || o.name || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    const phone = o["Ø§Ù„Ù‡Ø§ØªÙ"] || o.phone || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    const address = o["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || o.address || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    const total = (o["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] || o.total || 0);
    const date = o["Ø§Ù„ØªØ§Ø±ÙŠØ®"] || o.date || '';
    const done = o["ØªÙ…"] || false;

    // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    table.innerHTML += `
      <tr>
        <td>${id}</td>
        <td>${client}</td>
        <td>${phone}</td>
        <td>${address}</td>
        <td>${total.toFixed ? total.toFixed(2) + ' Ø¬.Ù…' : total + ' Ø¬.Ù…'}</td>
        <td>${date}</td>
        <td><input type="checkbox" onchange="toggleDone(${i}, this.checked)" ${done ? 'checked' : ''}></td>
        <td><button class="btn btn-sm btn-primary" onclick="viewOrder(${i})">ğŸ“„ ÙØ§ØªÙˆØ±Ø©</button></td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteOrder(${i})">Ø­Ø°Ù</button></td>
      </tr>
    `;
  });

  updateStats(); // ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©
}

function deleteOrder(i){
  if(!confirm('Ø­Ø°ÙØŸ'))return; // Ø¥Ø¶Ø§ÙØ© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
  const arr = fetchOrders();
  arr.splice(i,1);
  saveOrders(arr);
  renderAdminOrders();
}

function toggleDone(i, val){
  const arr = fetchOrders();
  if(!arr[i]) return;
  arr[i]["ØªÙ…"] = val;
  saveOrders(arr);
  // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ØŒ Ù„ÙƒÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateStats Ø¬ÙŠØ¯
  updateStats();
}

// ğŸ”´ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ğŸ”´ Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ù…Ù† script.js)
async function viewOrder(i){
  const orders = fetchOrders();
  const o = orders[i];
  if(!o) return alert("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± HTML Ù…Ø¤Ù‚Øª ÙŠØ­ØªÙˆÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¨Ø­Ø±ÙŠØ© RTL ÙˆØ®Ø· Cairo)
  const invoiceId = `invoice_tmp_${Date.now()}`;
  const wrapper = document.createElement('div');
  wrapper.id = invoiceId;
  wrapper.style.direction = 'rtl';
  wrapper.style.textAlign = 'right';
  wrapper.style.padding = '20px';
  wrapper.style.fontFamily = "'Cairo', sans-serif";
  wrapper.style.background = 'white';
  wrapper.style.width = '800px'; // Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±
  wrapper.innerHTML = `
    <div style="font-family: 'Cairo', sans-serif; color:#222;">
      <h1 style="text-align:center;margin-bottom:4px;">ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨</h1>
      <p style="text-align:center;margin-top:0;margin-bottom:6px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <strong>${o["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"] || i+1}</strong></p>
      <p style="margin:0;"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o["Ø§Ù„Ø¹Ù…ÙŠÙ„"] || o.name || '-'}</p>
      <p style="margin:0;"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o["Ø§Ù„Ù‡Ø§ØªÙ"] || o.phone || '-'}</p>
      <p style="margin:0 0 6px 0;"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${o["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || o.address || '-'}</p>
      <p style="margin:0 0 12px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${o["Ø§Ù„ØªØ§Ø±ÙŠØ®"] || o.date || ''}</p>

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="border:1px solid #ccc;padding:8px;background:#f4f4f4;">Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="border:1px solid #ccc;padding:8px;background:#f4f4f4;">Ø§Ù„Ø³Ø¹Ø±</th>
            <th style="border:1px solid #ccc;padding:8px;background:#f4f4f4;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="border:1px solid #ccc;padding:8px;background:#f4f4f4;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          </tr>
        </thead>
        <tbody>
          ${(o["Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª"] || o.items || []).map(item => `
            <tr>
              <td style="border:1px solid #ccc;padding:8px;">${item.name}</td>
              <td style="border:1px solid #ccc;padding:8px;">${item.price} Ø¬.Ù…</td>
              <td style="border:1px solid #ccc;padding:8px;">${item.qty}</td>
              <td style="border:1px solid #ccc;padding:8px;">${(item.price*item.qty).toFixed(2)} Ø¬.Ù…</td>
            </tr>
          `).join('')}
          <tr>
            <td colspan="3" style="border:1px solid #ccc;padding:8px;text-align:left;font-weight:bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
            <td style="border:1px solid #ccc;padding:8px;font-weight:bold;">${(o["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"] || o.total || 0).toFixed(2)} Ø¬.Ù…</td>
          </tr>
        </tbody>
      </table>
      <p style="text-align:center;margin-top:20px;color:#666;">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹ <strong>Ø§Ù„Ø·ÙŠØ¨Ø§Øª Ù„Ù„Ø­Ù„Ø§ÙˆØ© Ø§Ù„Ø·Ø­ÙŠÙ†ÙŠØ©</strong></p>
    </div>
  `;
  document.body.appendChild(wrapper);

  // Ø§Ø³ØªØ®Ø¯Ù… jsPDF.html Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ PDF
  if(window.jspdf && window.jspdf.jsPDF && window.html2canvas){
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
      const marginLeft = 20;
      const marginTop = 20;

      // Ù†Ø³ØªØ®Ø¯Ù… html2canvas ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…Ù„
      const canvas = await window.html2canvas(document.getElementById(invoiceId), {
          scale: 1.5, // Ø¬ÙˆØ¯Ø© Ø£Ø¹Ù„Ù‰
          useCORS: true,
          logging: false
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgProps = doc.getImageProperties(imgData);
      const pdfWidth = doc.internal.pageSize.getWidth() - (marginLeft * 2);
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

      doc.addImage(imgData, 'PNG', marginLeft, marginTop, pdfWidth, pdfHeight);
      
      const filename = `ÙØ§ØªÙˆØ±Ø©_Ø·Ù„Ø¨_${o["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"] || i+1}.pdf`;
      doc.save(filename);

    } catch (err){
      console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ PDF Ø¹Ø¨Ø± jsPDF:", err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù PDF. Ø§ÙØªØ­ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø²ÙŠØ¯.");
    } finally {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª
      const el = document.getElementById(invoiceId);
      if(el) el.remove();
    }
  } else {
    alert("Ù…ÙƒØªØ¨Ø© jsPDF Ø£Ùˆ html2canvas ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©.");
    const el = document.getElementById(invoiceId);
    if(el) el.remove();
  }
}


/* ğŸŸ¨ Feedback */
function renderFeedback(){
const arr=fetchFeedback(); const box=document.getElementById('feedbackList'); box.innerHTML='';
if(arr.length===0){ box.innerHTML='<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>'; return; }
arr.forEach((f,i)=>{
box.innerHTML+=`<div class="border p-2 mb-2 rounded">
<strong>${f.name} (${f.type})</strong> â€” <small>${f.date}</small><br>${f.msg}
<button class="btn btn-sm btn-danger float-end" onclick="deleteFeedback(${i})">Ø­Ø°Ù</button>
</div>`; });
}

function deleteFeedback(i){
const arr=fetchFeedback(); arr.splice(i,1);
saveFeedback(arr); renderFeedback(); updateStats();
}

window.addEventListener('load',()=>{});


</script>

</body>
</html>